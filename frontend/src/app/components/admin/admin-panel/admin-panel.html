<div class="admin-panel">
  <!-- Left Sidebar Navigation -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">Admin Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <button
        class="nav-tab"
        [class.active]="activeTab() === 'general'"
        (click)="activeTab.set('general')"
        type="button">
        <span class="tab-icon">üìä</span>
        <span class="tab-label">General</span>
      </button>
      <button
        class="nav-tab"
        [class.active]="activeTab() === 'products'"
        (click)="activeTab.set('products')"
        type="button">
        <span class="tab-icon">üì¶</span>
        <span class="tab-label">Products</span>
      </button>
      <button
        class="nav-tab"
        [class.active]="activeTab() === 'orders'"
        (click)="activeTab.set('orders')"
        type="button">
        <span class="tab-icon">üìã</span>
        <span class="tab-label">Orders</span>
      </button>
      <button
        class="nav-tab"
        [class.active]="activeTab() === 'sales'"
        (click)="activeTab.set('sales')"
        type="button">
        <span class="tab-icon">üí∞</span>
        <span class="tab-label">Sales</span>
      </button>
      <button
        class="nav-tab"
        [class.active]="activeTab() === 'users'"
        (click)="activeTab.set('users')"
        type="button">
        <span class="tab-icon">üë•</span>
        <span class="tab-label">Users</span>
      </button>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="admin-content">
    <!-- General Tab -->
    @if (activeTab() === 'general') {
      <header class="admin-header">
        <h1 class="admin-title">Dashboard Overview</h1>
        <p class="admin-subtitle">Welcome back, {{ currentUser()?.name }}</p>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üì¶</div>
          <div class="stat-content">
            <div class="stat-value">{{ stats().total }}</div>
            <div class="stat-label">Total Products</div>
          </div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon">‚ö†Ô∏è</div>
          <div class="stat-content">
            <div class="stat-value">{{ stats().lowStock }}</div>
            <div class="stat-label">Low Stock</div>
          </div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon">‚ú®</div>
          <div class="stat-content">
            <div class="stat-value">{{ stats().newProducts }}</div>
            <div class="stat-label">New Items</div>
          </div>
        </div>

        <div class="stat-card info">
          <div class="stat-icon">üî•</div>
          <div class="stat-content">
            <div class="stat-value">{{ stats().bestsellers }}</div>
            <div class="stat-label">Bestsellers</div>
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <h2 class="section-title">Quick Actions</h2>
        <div class="action-cards">
          <button class="action-card" (click)="activeTab.set('products')" type="button">
            <span class="action-icon">‚ûï</span>
            <span class="action-label">Add Product</span>
          </button>
          <button class="action-card" (click)="activeTab.set('sales')" type="button">
            <span class="action-icon">üìà</span>
            <span class="action-label">View Sales</span>
          </button>
          <button class="action-card" (click)="activeTab.set('users')" type="button">
            <span class="action-icon">üîç</span>
            <span class="action-label">Find User</span>
          </button>
        </div>
      </div>
    }

    <!-- Products Tab -->
    @if (activeTab() === 'products') {
      <header class="admin-header">
        <div class="header-content">
          <h1 class="admin-title">Product Management</h1>
          <p class="admin-subtitle">Manage your shop inventory</p>
        </div>
      </header>

      @if (isLoading()) {
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Loading products...</p>
        </div>
      }

      @if (errorMessage() && !isLoading()) {
        <div class="error-container">
          <p class="error-message">{{ errorMessage() }}</p>
          <button class="btn-retry" (click)="loadProducts()" type="button">
            Retry
          </button>
        </div>
      }

      @if (!isLoading() && !errorMessage()) {
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
              <div class="stat-value">{{ stats().total }}</div>
              <div class="stat-label">Total Products</div>
            </div>
          </div>

          <div class="stat-card warning">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-content">
              <div class="stat-value">{{ stats().lowStock }}</div>
              <div class="stat-label">Low Stock</div>
            </div>
          </div>

          <div class="stat-card success">
            <div class="stat-icon">‚ú®</div>
            <div class="stat-content">
              <div class="stat-value">{{ stats().newProducts }}</div>
              <div class="stat-label">New Items</div>
            </div>
          </div>

          <div class="stat-card info">
            <div class="stat-icon">üî•</div>
            <div class="stat-content">
              <div class="stat-value">{{ stats().bestsellers }}</div>
              <div class="stat-label">Bestsellers</div>
            </div>
          </div>
        </div>

        <!-- Search and Actions Bar -->
        <div class="actions-bar">
          <div class="search-box search-container">
            <input
              type="text"
              class="search-input"
              placeholder="Search products by title, category, description..."
              [value]="productSearch.query()"
              (input)="onProductSearchInput($event)"
              (keydown)="onProductSearchKeyDown($event)"
              (focus)="onProductSearchFocus()"
              (blur)="onProductSearchBlur()"
              autocomplete="off"
            />
            <span class="search-icon">üîç</span>

            <!-- Suggestions Dropdown -->
            @if (productSearch.isOpen() && productSearch.suggestions().length > 0) {
              <div class="suggestions-dropdown">
                @for (product of productSearch.suggestions(); track product.id; let idx = $index) {
                  <div
                    class="suggestion-item"
                    [class.active]="idx === productSearch.activeIndex()"
                    (mousedown)="selectProductSuggestion(product)"
                  >
                    <div class="suggestion-content">
                      <div class="suggestion-name" [innerHTML]="highlightProductText(product.title)"></div>
                      <div class="suggestion-email">{{ product.category }}</div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
          <button class="btn-primary" (click)="openEditor()" type="button">
            <span class="btn-icon">+</span>
            Add Product
          </button>
        </div>

        <!-- Products Table -->
        <div class="products-table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Badges</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (product of filteredProducts(); track product.id) {
                <tr class="product-row">
                  <!-- Product Info -->
                  <td class="product-cell">
                    <div class="product-info">
                      <img
                        [src]="getImageUrl(product.images[0])"
                        [alt]="product.title"
                        class="product-thumb"
                      />
                      <div class="product-text">
                        <div class="product-title" [innerHTML]="highlightProductText(product.title)"></div>
                        @if (product.subtitle) {
                          <div class="product-subtitle" [innerHTML]="highlightProductText(product.subtitle)"></div>
                        }
                      </div>
                    </div>
                  </td>

                  <!-- Category -->
                  <td class="category-cell">
                    <span class="category-badge" [innerHTML]="highlightProductText(product.category)"></span>
                  </td>

                  <!-- Price -->
                  <td class="price-cell">
                    <div class="price-info">
                      <span class="price">${{ product.price }}</span>
                      @if (product.salePrice) {
                        <span class="sale-price">${{ product.salePrice }}</span>
                      }
                    </div>
                  </td>

                  <!-- Stock Manager -->
                  <td class="stock-cell">
                    <app-stock-manager
                      [product]="product"
                      (stockUpdated)="onStockUpdated(product.id, $event)"
                    ></app-stock-manager>
                  </td>

                  <!-- Badge Toggles -->
                  <td class="badges-cell">
                    <app-badge-toggle
                      [product]="product"
                      (badgeToggled)="onBadgeToggled(product.id, $event)"
                    ></app-badge-toggle>
                  </td>

                  <!-- Actions -->
                  <td class="actions-cell">
                    <div class="action-buttons">
                      <button
                        class="btn-action btn-edit"
                        (click)="openEditor(product)"
                        type="button"
                        title="Edit product"
                      >
                        ‚úèÔ∏è
                      </button>
                      <button
                        class="btn-action btn-delete"
                        (click)="showDeleteConfirm.set(true); productToDelete.set(product)"
                        type="button"
                        title="Delete product"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="6" class="empty-state">
                    <div class="empty-content">
                      <div class="empty-icon">üì¶</div>
                      <p>No products found</p>
                      @if (productSearch.query()) {
                        <button
                          class="btn-secondary"
                          (click)="productSearch.setQuery('')"
                          type="button"
                        >
                          Clear Search
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    }

    <!-- Orders Tab -->
    @if (activeTab() === 'orders') {
      <app-admin-orders></app-admin-orders>
    }

    <!-- Sales Tab -->
    @if (activeTab() === 'sales') {
      <header class="admin-header">
        <h1 class="admin-title">Sales Analytics</h1>
        <p class="admin-subtitle">Track your shop performance</p>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üíµ</div>
          <div class="stat-content">
            <div class="stat-value">$0.00</div>
            <div class="stat-label">Total Revenue</div>
          </div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon">üìà</div>
          <div class="stat-content">
            <div class="stat-value">0</div>
            <div class="stat-label">Orders Today</div>
          </div>
        </div>

        <div class="stat-card info">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-value">0</div>
            <div class="stat-label">Total Orders</div>
          </div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon">‚≠ê</div>
          <div class="stat-content">
            <div class="stat-value">$0.00</div>
            <div class="stat-label">Avg Order Value</div>
          </div>
        </div>
      </div>

      <div class="content-section">
        <h2 class="section-title">Sales Data</h2>
        <div class="placeholder-content">
          <div class="placeholder-icon">üìä</div>
          <p class="placeholder-text">Sales analytics are currently in demo mode</p>
          <p class="placeholder-subtext">In a live environment, this would show charts, graphs, and detailed sales metrics</p>
        </div>
      </div>
    }

    <!-- Users Tab -->
    @if (activeTab() === 'users') {
      <header class="admin-header">
        <h1 class="admin-title">User Management</h1>
        <p class="admin-subtitle">{{ filteredUsers().length }} user{{ filteredUsers().length !== 1 ? 's' : '' }} total</p>
      </header>

      <div class="search-section">
        <div class="search-box-large search-container">
          <input
            type="text"
            class="search-input"
            placeholder="Search by name, email, or role..."
            [value]="userSearch.query()"
            (input)="onSearchInput($event)"
            (keydown)="onSearchKeyDown($event)"
            (focus)="onSearchFocus()"
            (blur)="onSearchBlur()"
            autocomplete="off"
          />
          <span class="search-icon">üîç</span>

          <!-- Suggestions Dropdown -->
          @if (userSearch.isOpen() && userSearch.suggestions().length > 0) {
            <div class="suggestions-dropdown">
              @for (user of userSearch.suggestions(); track user.id; let idx = $index) {
                <div
                  class="suggestion-item"
                  [class.active]="idx === userSearch.activeIndex()"
                  (mousedown)="selectUserSuggestion(user)"
                >
                  <div class="suggestion-avatar">
                    {{ getUserInitials(user.name) }}
                  </div>
                  <div class="suggestion-content">
                    <div class="suggestion-name" [innerHTML]="highlightText(user.name)"></div>
                    <div class="suggestion-email" [innerHTML]="highlightText(user.email)"></div>
                  </div>
                  <div class="suggestion-role">
                    <span class="user-role" [class.admin-role]="user.role === 'admin'">
                      {{ user.role }}
                    </span>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <div class="content-section">
        @if (loadingUsers()) {
          <div class="placeholder-content">
            <div class="placeholder-icon">‚è≥</div>
            <p class="placeholder-text">Loading users...</p>
          </div>
        } @else if (filteredUsers().length === 0) {
          <div class="placeholder-content">
            <div class="placeholder-icon">üë§</div>
            <p class="placeholder-text">No users found</p>
            <p class="placeholder-subtext">Try a different search term</p>
          </div>
        } @else {
          <div class="users-list">
            @for (user of filteredUsers(); track user.id) {
              <div class="user-card" [class.expanded]="isUserExpanded(user.id)">
                <div class="user-summary" (click)="toggleUserDetails(user.id)">
                  <div class="user-avatar">
                    {{ getUserInitials(user.name) }}
                  </div>
                  <div class="user-info">
                    <div class="user-name">{{ user.name }}</div>
                    <div class="user-email">{{ user.email }}</div>
                  </div>
                  <div class="user-meta">
                    <span class="user-role" [class.admin-role]="user.role === 'admin'">
                      {{ user.role }}
                    </span>
                    <span class="expand-icon">{{ isUserExpanded(user.id) ? '‚ñº' : '‚ñ∂' }}</span>
                  </div>
                </div>

                @if (isUserExpanded(user.id)) {
                  <div class="user-details">
                    <div class="user-details-section">
                      <h3 class="details-title">Account Information</h3>
                      <div class="details-grid">
                        <div class="detail-item">
                          <span class="detail-label">User ID:</span>
                          <span class="detail-value">{{ user.id }}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Email:</span>
                          <span class="detail-value">{{ user.email }}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Role:</span>
                          <span class="detail-value">{{ user.role }}</span>
                        </div>
                      </div>
                    </div>

                    <div class="user-details-section">
                      <h3 class="details-title">Order History ({{ userOrders().length }})</h3>
                      @if (userOrders().length > 0) {
                        <div class="orders-table">
                          @for (order of userOrders(); track order.id) {
                            <div class="order-row">
                              <div class="order-number">
                                <strong>#{{ order.orderNumber }}</strong>
                              </div>
                              <div class="order-date">
                                {{ formatDate(order.date) }}
                              </div>
                              <div class="order-status">
                                <span class="status-badge" [class]="'status-' + order.status">
                                  {{ order.status }}
                                </span>
                              </div>
                              <div class="order-total">
                                ${{ order.total.toFixed(2) }}
                              </div>
                              <div class="order-items">
                                {{ order.items.length }} item{{ order.items.length !== 1 ? 's' : '' }}
                              </div>
                            </div>
                          }
                        </div>
                      } @else {
                        <p class="empty-message">No orders found for this user</p>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Product Editor Modal -->
    @if (showEditor()) {
      <app-product-editor
        [product]="selectedProduct()"
        (save)="handleEditorSave($event)"
        (cancel)="showEditor.set(false); selectedProduct.set(null)"
      ></app-product-editor>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteConfirm()) {
      <div class="modal-overlay" (click)="showDeleteConfirm.set(false)">
        <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
          <h3 class="modal-title">Delete Product?</h3>
          <p class="modal-text">
            Are you sure you want to delete
            <strong>{{ productToDelete()?.title }}</strong>? This action cannot be
            undone.
          </p>
          <div class="modal-actions">
            <button
              class="btn-secondary"
              (click)="showDeleteConfirm.set(false)"
              type="button"
            >
              Cancel
            </button>
            <button
              class="btn-danger"
              (click)="deleteProduct(productToDelete()!)"
              type="button"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    }
  </main>
</div>
